language: rust
addons:
    apt:
      sources:
        - sourceline: 'deb http://apt.llvm.org/trusty/ llvm-toolchain-trusty-3.9 main'
          key_url: 'http://apt.llvm.org/llvm-snapshot.gpg.key'
      packages:
        - libclang-3.9-dev
        - llvm-3.9-dev
os:
  - linux
  - osx
env:
  - LLVM_VERSION=3.9
rust:
  - stable
  - nightly
cache:
  directories:
    - $HOME/.cargo

before_install:
  -
    if [ "${TRAVIS_OS_NAME}" = "osx" ]; then
      brew update >/dev/null;
      brew install llvm3${LLVM_VERSION#3.};
    fi

before_script:
  -
    if [ "${TRAVIS_OS_NAME}" = "linux" ]; then
      export LIBCLANG_PATH=/usr/lib/llvm-${LLVM_VERSION}/lib;
    elif [ "${TRAVIS_OS_NAME}" = "osx" ]; then
      export LIBCLANG_PATH=`brew --prefix llvm3${LLVM_VERSION#3.}`/lib/llvm-${LLVM_VERSION}/lib;
    fi
  - echo $LIBCLANG_PATH

script:
  - cargo build --verbose --features llvm_stable
  - cargo test --features llvm_stable
  - git add -A
  - git diff @
  - git diff-index --quiet HEAD
  - cargo build --features "llvm_stable _docs"

notifications:
  webhooks: http://build.servo.org:54856/travis
